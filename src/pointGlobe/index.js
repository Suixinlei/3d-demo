const THREE = require('three');
const Stats = require('stats.js');
const TWEEN = require('tween');
const dat = require('dat.gui');

const pointEarth = require('./scene/pointEarth/index');
const pointEarthBorder = require('./scene/pointEarthBorder');
const Label = require('./scene/label/index');

const props = require('./props');
const regionData = require('./region');

const {
  toScreenPosition,
} = require('./utils');

require('./index.css');

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x333333);
const camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 2000 );
camera.position.z = props.initCameraDistance;
scene.add(camera);

const renderer = new THREE.WebGLRenderer({ alpha: false });
renderer.setSize( window.innerWidth, window.innerHeight );
document.body.appendChild( renderer.domElement );

// clock
const clock = new THREE.Clock();

let mesh;
let hiddenTube;
var params = {
  extrusionSegments: 100,
  radiusSegments: 3,
  closed: true,
  scale: 1.4,
};

// 鼠标
var raycaster = new THREE.Raycaster();
var mouse = new THREE.Vector2();

function onMouseMove( event ) {
	mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
}
window.addEventListener('mousemove', onMouseMove, false );

// 环境光
const ambient = new THREE.AmbientLight( 0xffffff, 0.1 );
scene.add( ambient );
// 点状光源
const pointLight = new THREE.PointLight( 0xff0000, 5, 1000);
pointLight.position.set( 0, 0, 0 );
scene.add( pointLight );
var sphereSize = 5;
var pointLightHelper = new THREE.PointLightHelper( pointLight, sphereSize );
scene.add( pointLightHelper );

var controls = new THREE.OrbitControls( camera, renderer.domElement );
controls.addEventListener( 'change', render );
controls.minDistance = 500;
controls.maxDistance = 1000;
controls.enablePan = false;
// controls.maxPolarAngle = Math.PI / 3;
// controls.minPolarAngle = Math.PI / 3;

controls.update();

// stats
const stats = new Stats();
document.body.appendChild( stats.dom );

// axisHelper
var axesHelper = new THREE.AxesHelper( 1000 );
scene.add( axesHelper );

// 内藏球体
const earthGeometry = new THREE.SphereGeometry(props.globeRadius, 64, 64);
const earthMaterial = new THREE.MeshBasicMaterial({ color: 0x111111, transparent: false });
const earth = new THREE.Mesh(earthGeometry, earthMaterial);
// scene.add(earth);

pointEarth.Init(scene);
pointEarthBorder.Init(scene);

const regions = [];
regionData.forEach((dataItem) => {
  regions.push(
    new Label(dataItem, scene),
  );
});


// 画出路径点
const targets = [[406.9845861278568,387.5661835794464,-4.9841237070379005e-14],[406.9709689742866,387.57114444022307,-2.6904292270958012],[406.9274835164599,387.58541298679455,-5.618789800053831],[406.8500476529964,387.60806780056294,-8.77636033152674],[406.73444392550476,387.63818712607485,-12.154341044277928],[406.57636743802027,387.674849041693,-15.743851542887954],[406.37147207624497,387.7171316104625,-19.5359294209658],[406.11541499172006,387.76411301119003,-23.521529855603724],[405.8038993130832,387.8148716497426,-27.691526313850495],[405.43271504382676,387.86848625057036,-32.03671246995098],[404.9977781036815,387.9240359284436,-36.547805407011076],[404.4951674690512,387.9806002403956,-41.21545015266225],[403.9211603669591,388.0372592178542,-46.03022557521425],[403.2722654768455,388.0930933789445,-50.98265164479483],[402.5452540953406,388.147183720942,-56.0631980430917],[401.73718922090063,388.1986116928584,-61.26229408557702],[400.8454525179456,388.2464591481388,-66.57033990161091],[399.8677691239003,388.28980827745653,-71.97771880055124],[398.8022302672691,388.32774152159124,-77.47481073608604],[397.6473136705724,388.35934146438433,-83.05200676640604],[396.4019017185392,388.383690705771,-88.69972439466534],[395.06529737934613,388.39987171489423,-94.40842366241732],[393.6372378748106,388.4069666633188,-100.16862385841884],[392.1179061041895,388.40405723837057,-105.97092069638087],[390.5079398354948,388.39022443663924,-111.80600380791104],[388.80843868787633,388.3645483376955,-117.66467439105799],[387.0209689385281,388.3261078580889,-123.53786285050758],[385.14756619759606,388.2739804857062,-129.41664626258043],[383.1907360045691,388.2072419945896,-135.29226549670483],[381.15345240947494,388.12496614033097,-141.1561418249489],[379.0391546117414,388.0262243361779,-146.99989285243205],[376.8517417386755,387.91008531000966,-152.81534760392267],[374.59556585402333,387.7756147423627,-158.5945606056109],[372.27542329487386,387.6218748857098,-164.32982480581452],[369.8910386601306,387.44578691993553,-170.03053171981102],[367.4255120631508,387.2407322677258,-175.74728549222885],[364.87338510855614,387.00792695771037,-181.48354556630977],[362.23035181243455,386.74917070488476,-187.23848745630207],[359.4920707726021,386.4662628388362,-193.0110844977822],[356.6541719102733,386.1610033796748,-198.80010344011401],[353.7122634192106,385.835194031781,-204.60410004033858],[350.66193893893114,385.49063909514604,-210.4214146649653],[347.4987849687633,385.129146294209,-216.25016790728068],[344.2183885397506,384.7525275242096,-222.0882562289812],[340.81634516158,384.3625995151794,-227.933347636182],[337.2882670618878,383.9611844137909,-233.78287740112117],[333.6297917354405,383.55011028336725,-239.63404384223767],[329.8365908208151,383.1312115224337,-245.48380417667954],[325.90437932228855,382.7063292022506,-251.328870460782],[321.82892519471227,382.2773113238293,-257.1657056355695],[317.60605930915995,381.84601299497234,-262.9905196959575],[313.2316858171044,381.4142965279134,-268.79926600400483],[308.701792930796,380.98403145815905,-274.58763776834604],[304.0124641373598,380.5570944851439,-280.3510647137901],[299.15988986390806,380.1353693353147,-286.0847099670277],[294.1403796106525,379.72074654825013,-291.78346718644093],[288.9503745686061,379.3151231864074,-297.44195796615986],[283.58646073794597,378.92040246904656,-303.0545295467818],[278.04538256248725,378.53849333085617,-308.61525286752357],[272.3240570949507,378.17130990573946,-314.11792099707264],[266.41958870679616,377.82077093616397,-319.5560479829858],[260.3292843553095,377.48879910839895,-324.9228681622013],[254.05066941937324,377.1773203138824,-330.2113359780481],[247.5815041138722,376.888262836857,-335.4141263520797],[240.91980049100067,376.62355646831276,-340.52363566210215],[234.06384003478834,376.38513154614554,-345.5319833809307],[227.0121918529585,376.17491792131887,-350.43101443366095],[219.77170236529614,375.9936657501083,-355.2086177941852],[212.44378296528222,375.8274187571311,-359.81299363662794],[205.05500110324854,375.6716175799816,-364.2352018509288],[197.59911259929592,375.526272802266,-368.4814908990801],[190.06931231732364,375.3913942875168,-372.55732124076405],[182.4582844377211,375.2669911805654,-376.4673422361216],[174.7582515361537,375.1530719088177,-380.21536812365156],[166.96102285716626,375.0496441834298,-383.8043528210324],[159.05804219216037,374.9567150003851,-387.2363633365505],[151.04043579230935,374.87429064147324,-390.51255161866635],[142.89906076840396,374.80237667516974,-393.63312471151636],[134.62455445155112,374.7409779574157,-396.59731312534257],[126.20738521121055,374.69009863229905,-399.4033373734715],[117.63790525018184,374.64974213263565,-402.0483726721188],[108.90640591981862,374.6199111804513,-404.5285118465428],[100.0031761227591,374.60060778736437,-406.83872653755276],[90.91856439459569,374.5918332548677,-408.9728268567279],[81.64304527979436,374.5935881745123,-410.9234196976188],[72.16729064041037,374.60587242798977,-412.6818659743692],[62.4822465581259,374.6286851871161,-414.2382371293387],[52.57921651020721,374.662024913715,-415.58127132815736],[42.44995151728632,374.7058893594021,-416.69832984493667],[32.08674797446089,374.7602755652689,-417.5753542328225],[21.48255388589354,374.82517986146723,-418.19682497642],[10.631084225559498,374.9005978666944,-418.5457224335045],[-0.47305385850659626,374.9865244875784,-418.6034909944897],[-11.83422529397244,375.082953917964,-418.35000751985893],[-23.45562011185453,375.18987963809946,-417.76355525861374],[-35.33909461614143,375.30729441372404,-416.8208046050026],[-47.485000116011065,375.4351902950564,-415.4968022164518],[-59.89199871696106,375.5735586156843,-413.76497019254623],[-72.55686576516236,375.7223899913559,-411.597117202635],[-85.47427866299707,375.8816743186715,-408.963463647344],[-98.63659192683627,376.0514007736783,-405.8326831456692],[-112.13532885218584,376.32314867303904,-402.0579010491174],[-126.01390866636619,376.776918571185,-397.49672760241367],[-140.18912901981193,377.3952183133894,-392.1273483179357],[-154.57633074822445,378.1604550448543,-385.93370960915587],[-169.09015908852763,379.05499200035706,-378.90609804940544],[-183.64538023976033,380.0611993475189,-371.04158670844345],[-198.1577394178971,381.1614991959258,-362.34434153095737],[-212.54484426784566,382.33840482222405,-352.82578331685784],[-226.72705580675347,383.57455410750333,-342.50460377406813],[-240.62836803229092,384.85273713791275,-331.40663725334923],[-254.1772569702087,386.1559178825885,-319.56459303770816],[-267.3074802671219,387.46724983453583,-307.0176563308757],[-279.95880944268754,388.7700854800435,-293.81096924940135],[-292.0776785603757,390.0479794503166,-279.99500605101383],[-303.61773529363296,391.2846852051143,-265.62485941473943],[-314.5402830674775,392.4641451020559,-250.75945672525205],[-324.8146060379977,393.5704737166694,-235.46072692238272],[-334.4181720122928,394.58793429698346,-219.79273949608984],[-343.3367118774281,395.50090826232747,-203.82083760221855],[-351.56417756296156,396.2938576888273,-187.61078703684913],[-359.10258387315133,396.95128076380746,-171.22796195598224],[-365.9617425650254,397.45766023790026,-154.73658680798124],[-372.1588997028308,397.7974049572326,-138.19905202739204],[-377.7182894910513,397.95478461879776,-121.67531870909832],[-382.67061940111955,397.91385796039174,-105.22242484490033],[-387.052502408366,397.6583946727649,-88.89410287359519],[-390.90585251705875,397.1717914065944,-72.74051538715004],[-394.2772594680044,396.43698234133643,-56.80811296368577],[-397.21735761287414,395.4363448880027,-41.13961536843329],[-399.7802024396499,394.15160121462685,-25.774114868572212],[-402.0226661979852,392.5637164130494,-10.747298220407494],[-404.00386156740115,390.65279427024876,3.908217941069222],[-405.7845994081767,388.3979717685418,18.162445023415486],[-407.45468333625854,385.743166022995,32.04513838174849],[-409.1301286925566,382.57518770333377,45.746732667711605],[-410.7993802993978,378.9058332590211,59.31474241634744],[-412.43835727494,374.75591320594197,72.77779170550231],[-414.019784150368,370.1462550757497,86.15897042955424],[-415.51404846277813,365.0980430564227,99.47610007656452],[-416.88996664936195,359.63312277110566,112.74206274943134],[-418.1154626894887,353.7742696056243,125.96517782689712],[-419.15816423603866,347.54541952502825,139.14961272474414],[-419.98592103511305,340.97186183441727,152.29581599459277],[-420.5672503284263,334.08039384231125,165.40096251640426],[-420.8717137249601,326.8994378763772,178.45940183224826],[-420.87022976495797,319.4591215794039,191.4631017645624],[-420.53532611665906,311.79132287393224,204.4020803917576],[-419.84133507216524,303.9296814212069,217.26482024484673],[-418.7645357642667,295.9095788071663,230.03865926470638],[-417.2832463259411,287.76809005726125,242.710153641087],[-415.3778690691612,279.54390940482045,255.2654081583174],[-413.0308916766743,271.27725350623916,267.6903701123427],[-410.2268473841663,263.0097455025758,279.9710832495353],[-406.95223718348905,254.78428346386158,292.0938985175142],[-403.19541720214943,246.64489681318958,304.04563871760394],[-398.9464546112403,238.6365943070001,315.81371441195813],[-394.1969556846278,230.80520704178016,327.3861886692422],[-388.93986997805206,223.19722976267462,338.7517884347237],[-383.16927502011646,215.8596634645754,349.8998604879953],[-376.88014641118593,208.83986190066022,360.82027011019795],[-370.0681188152527,202.18538414770128,371.50324073093424],[-362.7292440093292,195.94385482337324,381.9391329745845],[-354.85975293121334,190.16283291064028,392.11816169236306],[-346.45582954662456,184.88968942111345,402.0300497710644],[-337.5134053477791,180.17149332649973,411.6636177791824],[-328.0279844038139,176.0549043086406,421.00630888010056],[-317.9984942176775,172.56633980305142,430.0486205561732],[-307.48048000755335,169.47920715284172,438.83545066137134],[-296.5138869431489,166.71074104822316,447.36008278457064],[-285.126207507731,164.25286403944102,455.5963591240599],[-273.3461102609282,162.0972229266067,463.5195727525457],[-261.2034090771009,160.23522032968864,471.10662620302514],[-248.72901612059906,158.65804286636293,478.33618091619843],[-235.95487902992667,157.35668628746933,485.188796596335],[-222.91390298618848,156.32197789798474,491.6470594659609],[-209.63985854079678,155.54459656935384,497.69569838313015],[-196.1672762708247,155.01509062691377,503.3216877886504],[-182.5313295149137,154.72389387416675,508.5143364841681],[-168.76770661536878,154.66133999394376,513.265361304527],[-154.91247424999688,154.81767554517367,517.568944837819],[-141.00193357744087,155.183071753125,521.4217764619037],[-127.07247103937168,155.7476352707074,524.8230761042532],[-113.16040575934603,156.50141806877207,527.7746002895968],[-99.30183554926808,157.4344265943926,530.2806302133248],[-85.53248357828015,158.5366303178954,532.3479417640104],[-71.88754777437461,159.79796977196767,533.9857576113285],[-58.4015550151985,161.20836416955865,535.2056816716184],[-45.10822212138127,162.75771867150138,536.0216164576728],[-32.040325593568035,164.43593135988473,536.4496640074121],[-19.22958193428803,166.23289995917835,536.5080112633867],[-6.706540269504333,168.13852833399767,536.2168009371685],[5.4995111658124305,170.14273278020576,535.5979890356391],[17.36062328570806,172.23544811478365,534.6751903462807],[28.850247952959343,174.40663355957625,533.4735132726539],[39.94328232422982,176.64627840465363,532.0193854766502],[50.616094961714836,178.94440742859896,530.3403718187541],[60.846533157661845,181.2910860455782,528.4649860900041],[70.61391114792393,183.67642514253004,526.4224979987594],[79.89897912148658,186.09058556426197,524.2427368115789],[88.68387316149376,188.5237821996433,521.9558929509442],[96.9044021170549,191.11121069467197,519.547920789943],[104.52630985648342,193.9822926941107,517.0001167010727],[111.5781596977075,197.1185595047763,514.3331486276525],[118.08906121322468,200.50147559006368,511.56439663837676],[124.08850916508602,204.11246391539936,508.70830931642075],[129.60625386786552,207.9329314581471,505.7767442000076],[134.6721973691371,211.94429501777594,502.77929060889755],[139.3163105264652,216.1280073913842,499.72357363078567],[143.5685667231017,220.46558391418148,496.61553837798243],[147.45888859425796,224.9386293044068,493.45971387865177],[151.01710472679397,229.5288646975061,490.2594561562384],[154.27291384398046,234.2181547053304,487.0171701906594],[157.25585449109704,238.98853429269684,483.73451055811944],[159.99527869544892,243.82223522593824,480.41256062325533],[162.52032848477785,248.70171181608,477.0519902159003],[164.85991451025563,253.6096656530086,473.6531917711951],[167.04269633383498,258.5290690063909,470.21639495046423],[169.09706420434827,263.4431865541083,466.7417597940941],[171.05112236225108,268.33559508945996,463.22944848811113],[172.9326740792797,273.1902008542335,459.67967585375493],[174.7692087565711,277.991254145767,456.09273869364074],[176.58789147314488,282.72336085211776,452.4690241481202],[178.41555539634865,287.3714905802043,448.8089972296946],[180.2786974371822,291.9209810570148,445.11316771026105],[182.2034774567063,296.3575385034369,441.38203653396175],[184.21572120533222,300.6672337036726,437.6160219162233],[186.34092700495114,304.83649352025157,433.8153652663921],[188.60427596473826,308.8520876351128,429.9800170371286],[191.03064525507295,312.70111033077876,426.10950255929356],[193.64462365010212,316.3709571620713,422.2027678684321],[196.4705281875799,319.8492964079135,418.2580054715702],[199.5324203839751,323.12403523433056,414.2724599458619],[202.85411998249745,326.1832805436924,410.2422132105391],[206.38489108263377,329.0516315535295,406.1702851080685],[209.89749680272365,331.84122742454866,402.08014203305237],[213.37738627565955,334.5615840835053,397.9731617605686],[216.82812615573263,337.2133582247622,393.8485936785505],[220.25318004697013,339.79720316120586,389.705526523578],[223.65590554679932,342.3137681132117,385.54289005787086],[227.03955123543346,344.7636975181278,381.3594564822563],[230.40725358258575,347.1476303600178,377.15384159776823],[233.76203374328463,349.46619951940073,372.92450572960456],[237.1067942147376,351.72003114272127,368.6697544282325],[240.44431532627644,353.90974403127956,364.387738963583],[243.77725153452815,356.0359490493538,360.0764566294182],[247.1081274959718,358.09924855123614,355.73375087623407],[250.4393338890985,360.1002358269133,351.35731129234534],[253.7731229584102,362.03949456611537,346.9446734542086],[257.11160375249153,363.9175983404581,342.4932186685378],[260.45673702843453,365.7351101034082,338.00017363035295],[263.8103297949149,367.4925817077968,333.46261002282785],[267.17402946629613,369.19055344061354,328.8774440866326],[270.54931760023686,370.8295535748144,324.24143618845204],[273.93750319143874,372.4100979378754,319.5511904204749],[277.33971549439826,373.93268949683693,314.80315426492854],[280.7568963483396,375.3978179595768,309.99361836017874],[284.18979197792055,376.80595939206137,305.11871640752304],[287.6389442438433,378.1575758513281,300.1744252606047],[291.10468131817925,379.45311503395413,295.1565652423643],[294.58710776007473,380.69300993977635,290.06080073761694],[298.0860939685274,381.87767855062935,284.882641112737],[301.6012649902027,383.00752352387855,279.6174420175093],[305.1319886617461,384.0829319005282,274.2604071280109],[308.67736306784155,385.1042748276934,268.8065903933912],[312.23620329836046,386.0719072952329,263.2508988536335],[315.8070274903872,386.98616788634405,257.5880960998162],[319.4002616765365,387.84456750917104,251.8016367988583],[323.16232519947323,388.6123114855951,245.74495505196597],[327.1078024214813,389.282917775146,239.38106759611975],[331.2004051520864,389.8614182425067,232.7195011017236],[335.40461055707715,390.3527598063612,225.77083542524423],[339.68581812760954,390.7618135821094,218.5469057410727],[344.01051092064296,391.09338366498184,211.06097135565713],[348.34641993420183,391.35221552757884,203.32785131575108],[352.66268999253117,391.5430040090453,195.36402713602266],[356.9300451039297,391.6704008760497,187.18771321777848],[361.12095091960015,391.73902193847255,178.8188958069385],[365.2097716663804,391.7534537052403,170.2793416401604],[369.17291874993396,391.718259568079,161.59257774603944],[372.9889881271326,391.6379855030992,152.78384419490183],[376.6388835248769,391.5171652820956,143.88002191620063],[380.1059226340846,391.3603251872234,134.90953801656156],[383.3759235271891,391.17198822433454,125.90225132338185],[386.4372687289483,390.9566778317026,116.88932113802747],[389.28094460601386,390.7189210821476,107.90306239885928],[391.9005540216551,390.46325137769287,98.97679061820749],[394.29230051835907,390.19421063684575,90.14466006053198],[396.4549426320112,389.9163509753916,81.44149866428015],[398.38971729583056,389.63423588222474,72.90264317171955],[400.10023164892175,389.35244089222255,64.56377781502185],[401.5923229121711,389.07555375847625,56.46077971071283],[402.87388632294994,388.8081741263491,48.6295738370951],[403.95467142042787,388.5549127118183,41.10600011099931],[404.8460472374902,388.3203899863808,33.92569464292577],[405.5607371774391,388.1092343704613,27.123986736217304],[406.112524530209,387.9260799367532,20.73581261017124],[406.51592971273783,387.7755636242432,14.795646173413411],[406.78586040328554,387.6623219628349,9.337446457251719],[406.93723578495013,387.5909873074656,4.39462054425373],[406.9845861278568,387.5661835794464,4.9841237070379005e-14]];

const LineGroup = [];

var material = new THREE.MeshLambertMaterial( { color: 0xff00ff } );
function addGeometry( geometry ) {
  // 3D shape
  const mesh = new THREE.Mesh( geometry, material );
  // scene.add( mesh );
}
function setArc3D(pointStart, pointEnd, smoothness, color, clockWise) {
  // calculate a normal ( taken from Geometry().computeFaceNormals() )
  var cb = new THREE.Vector3(), ab = new THREE.Vector3(), normal = new THREE.Vector3();
  cb.subVectors(new THREE.Vector3(), pointEnd);
  ab.subVectors(pointStart, pointEnd);
  cb.cross(ab);
  normal.copy(cb).normalize();


  var angle = pointStart.angleTo(pointEnd); // get the angle between vectors
  if (clockWise) angle = angle - Math.PI * 2;  // if clockWise is true, then we'll go the longest path
  var angleDelta = angle / (smoothness - 1); // increment

  const vertices = [];
  for (var i = 0; i < smoothness; i++) {
    vertices.push(pointStart.clone().applyAxisAngle(normal, angleDelta * i))  // this is the key operation
  }

  // console.log(pointStart, pointEnd, vertices);
  return vertices;
}

for (let i = 0; i < targets.length; i++) {
  console.log(i);
  const firstVec = new THREE.Vector3(...targets[i]);
  let secondVec;
  if (i === targets.length - 1) {
    secondVec = new THREE.Vector3(...targets[0]);
  } else {
    secondVec = new THREE.Vector3(...targets[i + 1]);
  }
  const lineVertices = setArc3D(firstVec, secondVec, 50, 0xff0000, false);
  LineGroup.push(...lineVertices.slice(0, -1));
}

const lineSpline = new THREE.CatmullRomCurve3(LineGroup);


hiddenTube = new THREE.TubeBufferGeometry( lineSpline, params.extrusionSegments, 2, params.radiusSegments, params.closed );
addGeometry(hiddenTube);

var gui = new dat.GUI( { width: 300 } );
var folderGeometry = gui.addFolder( 'Geometry' );

folderGeometry.add( params, 'scale', 2, 10 ).step( 2 ).onChange( function () {
  setScale();
} );
folderGeometry.add( params, 'extrusionSegments', 50, 500 ).step( 50 ).onChange( function () {
  addTube();
} );
folderGeometry.add( params, 'radiusSegments', 2, 12 ).step( 1 ).onChange( function () {
  addTube();
} );
folderGeometry.add( params, 'closed' ).onChange( function () {
  addTube();
} );
folderGeometry.open();

function render() {
  if (regions && Array.isArray(regions)) {
    regions.forEach((region) => {
      region.render(camera, renderer);
    });
  }

  const delta = clock.getDelta();
  pointEarth.update(delta);

  var time = Date.now();
  var looptime = 20 * 1000;
  var t = (time % looptime) / looptime;
  var pos = hiddenTube.parameters.path.getPointAt( t );
  pos.multiplyScalar(params.scale);

  camera.position.copy( pos );

  camera.lookAt(new THREE.Vector3(0, 0, 0));
  renderer.render( scene, camera );
}

const animate = () => {
  requestAnimationFrame( animate );

  TWEEN.update();
  stats.update();

  render();
};

render();
animate();
